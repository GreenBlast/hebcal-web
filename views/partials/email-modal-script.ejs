<script>
document.addEventListener('DOMContentLoaded', function() {
function show(el) { if (el) { el.style.display = 'block' } }
function hide(el) { if (el) { el.style.display = 'none' } }
const resource = '<%=resource%>';
const emailModalSuccess = document.getElementById('email-modal-success');
const emailModalFailure = document.getElementById('email-modal-failure');
const emailModalAlready = document.getElementById('email-modal-already');
const emailModalEntry = document.getElementById('email-modal-entry');
const emailModal = document.getElementById('email-modal');
const emailSubscribeBtn = document.getElementById('email-subscribe');
const emailForm = document.getElementById('f2');
const emailInput = document.getElementById('em');
emailModal.addEventListener('show.bs.modal', function () {
  hide(emailModalSuccess);
  hide(emailModalFailure);
  show(emailModalEntry);
  show(emailSubscribeBtn);
  emailSubscribeBtn.textContent = 'Subscribe';
  emailSubscribeBtn.disabled = false;
  emailForm.classList.remove('was-validated');
  emailForm.classList.remove('is-invalid');
});
function validateEmail(email) {
  // eslint-disable-next-line max-len
  const re = /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
  return re.test(String(email).toLowerCase());
}
function doSubscribe(event) {
  event.preventDefault();
  event.stopPropagation();
  hide(emailModalSuccess);
  hide(emailModalFailure);
  hide(emailModalAlready);
  emailForm.classList.remove('was-validated');
  if (!emailForm.checkValidity()) {
    emailForm.classList.add('was-validated');
    return;
  }
  emailInput.classList.remove('is-invalid');
  if (!validateEmail(emailInput.value)) {
    emailForm.classList.add('was-validated');
    emailInput.classList.add('is-invalid');
    return;
  }
  emailForm.classList.add('was-validated');

  emailSubscribeBtn.textContent = 'Subscribing...';
  emailSubscribeBtn.disabled = true;
  const params = new URLSearchParams();
  const formData = new FormData(emailForm);
  for (const pair of formData) {
    params.append(pair[0], pair[1]);
  }
  fetch(resource, {
    method: 'POST',
    credentials: 'omit',
    body: params,
    headers: {
      'Accept': 'application/json',
    },
  }).then(function(response) {
    if (response.ok) {
      response.json().then(function(data) {
        if (data.alreadySubscribed) {
          show(emailModalAlready);
          hide(emailModalFailure);
          hide(emailModalEntry);
          hide(emailSubscribeBtn);
        } else if (data.ok) {
          show(emailModalSuccess);
          hide(emailModalFailure);
          hide(emailModalEntry);
          hide(emailSubscribeBtn);
        } else {
          show(emailModalFailure);
          emailSubscribeBtn.textContent = 'Subscribe';
          emailSubscribeBtn.disabled = false;
        }
      });
    } else {
      show(emailModalFailure);
      emailSubscribeBtn.textContent = 'Subscribe';
      emailSubscribeBtn.disabled = false;
    }
  });
};
emailForm.addEventListener('submit', doSubscribe);
emailSubscribeBtn.addEventListener('click', doSubscribe);
});
</script>
