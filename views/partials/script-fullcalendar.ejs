<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.9/index.global.min.js" integrity="sha384-wv6yRjQC0TqzEnAjFQVXM2V0JrF6Nk0dh6QAGf1RwzTqPArdwU3luBZjVCi2YSVH" crossorigin="anonymous"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
 var calendar = null;
 var calendarEl = document.getElementById('calendar');
 calendarEl.style.display = 'none';
 var listViewEl = document.getElementById('list-view');
 var toggleMonth = document.getElementById('toggle-month');
 toggleMonth.addEventListener('change', function(event) {
  var fc = this.checked;
  calendarEl.style.display = fc ? 'block' : 'none';
  listViewEl.style.display = fc ? 'none' : 'block';
  if (fc) {
    makeFullCalendar();
    calendar.render();
  }
  toggleMonth.blur();
 });
 function makeFullCalendar() {
  if (calendar) {
    return calendar;
  }
  var opts = {
    initialView: 'dayGridMonth',
    headerToolbar: {
      left: 'prev next',
      center: 'title',
      right: '',
    },
    initialDate: '<%=isoDateStart%>',
    timeZone: 'local',
    eventDisplay: 'block',
    events: function(info, successCallback, failureCallback) {
      var url = new URL(document.location.href);
      url.pathname = '/hebcal';
      var sp = url.searchParams;
      sp.set('v', '1'); // Required, version 1
      sp.set('cfg', 'fc'); // Required, mode = FullCalendar
      sp.set('start', info.startStr.substring(0, 10));
      sp.set('end', info.endStr.substring(0, 10));
      sp.set('i', '<%=il?"on":"off"%>');  // Israel or Diaspora holiday schedule
      sp.set('maj', 'on'); // Major holidays
      sp.set('min', 'on'); // Minor holidays
      sp.set('nx', 'on'); // Rosh Chodesh
      sp.set('mf', 'on'); // Minor fasts
      sp.set('ss', 'on'); // Special Shabbatot
      sp.set('mod', 'on'); // Modern holidays
      sp.set('D', 'on'); // Show Hebrew date for dates with some event
      sp.set('lg', 's'); // Sephardic transliterations
      var fetchOptions = {
        method: 'GET',
        credentials: 'omit',
        mode: 'cors',
      };
      fetch(url.href, fetchOptions).then(function(fetchRes) {
        if (fetchRes.ok) {
          fetchRes.json().then(function(parsedResponse) {
            var events = parsedResponse.map(function(ev) {
              if (ev.emoji) {
                ev.title += '\u00a0' + ev.emoji;
              }
              if (typeof ev.url == 'string') {
                var u = new URL(ev.url);
                var p = u.pathname;
                if (p.substring(0, 3) == '/h/') {
                  ev.url = '/holidays/' + p.substring(3);
                }
              }
              return ev;
            });
            successCallback(events);
          }, function(err) {
            failureCallback(err);
          });
        } else {
          failureCallback('Request failed');
        }
      }).catch(function(err) {
        failureCallback(err);
      });
    },
  };
  calendar = new FullCalendar.Calendar(calendarEl, opts);
  document.addEventListener('keydown', function(e) {
    if (e.key === 'ArrowLeft' && !e.metaKey) {
      calendar.prev();
    } else if (e.key === 'ArrowRight' && !e.metaKey) {
      calendar.next();
    }
  });
  var _paq = window._paq = window._paq || [];
  _paq.push(['trackEvent', 'Interaction', 'fullcalendar', '<%=year%>']);
  return calendar;
 }
});
</script>
