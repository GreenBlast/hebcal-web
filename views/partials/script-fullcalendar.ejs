<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.9/index.global.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  var calendarEl = document.getElementById('calendar');
  calendarEl.style.display = 'none';
  var opts = {
    initialView: 'dayGridMonth',
    headerToolbar: {
      left: 'prev next',
      center: 'title',
      right: '',
    },
    initialDate: '<%=isoDateStart%>',
    eventDisplay: 'block',
    events: function(info, successCallback, failureCallback) {
      var url = new URL(document.location.href);
      url.pathname = '/hebcal';
      var sp = url.searchParams;
      sp.set('v', '1'); // Required, version 1
      sp.set('cfg', 'fc'); // Required, mode = FullCalendar
      sp.set('start', info.startStr);
      sp.set('end', info.endStr);
      sp.set('i', '<%=il?"on":"off"%>');  // Israel or Diaspora holiday schedule
      sp.set('maj', 'on'); // Major holidays
      sp.set('min', 'on'); // Minor holidays
      sp.set('nx', 'on'); // Rosh Chodesh
      sp.set('mf', 'on'); // Minor fasts
      sp.set('ss', 'on'); // Special Shabbatot
      sp.set('mod', 'on'); // Modern holidays
      sp.set('D', 'on'); // Show Hebrew date for dates with some event
      sp.set('lg', 's'); // Sephardic transliterations
      var fetchOptions = {
        method: 'GET',
        credentials: 'omit',
        mode: 'cors',
      };
      fetch(url.href, fetchOptions).then(function(fetchRes) {
        if (fetchRes.ok) {
          fetchRes.json().then(function(parsedResponse) {
            var events = parsedResponse.map(function(ev) {
              if (ev.emoji) {
                ev.title += '\u00a0' + ev.emoji;
              }
              if (typeof ev.url == 'string') {
                var u = new URL(ev.url);
                var p = u.pathname;
                if (p.substring(0, 3) == '/h/') {
                  ev.url = '/holidays/' + p.substring(3);
                }
              }
              return ev;
            });
            successCallback(events);
          }, function(err) {
            failureCallback(err);
          });
        } else {
          failureCallback('Request failed');
        }
      }).catch(function(err) {
        failureCallback(err);
      });
    },
  };
  var calendar = new FullCalendar.Calendar(calendarEl, opts);
  var listViewEl = document.getElementById('list-view');
  var toggleMonth = document.getElementById('toggle-month');
  toggleMonth.onchange = function() {
    calendarEl.style.display = this.checked ? 'block' : 'none';
    listViewEl.style.display = this.checked ? 'none' : 'block';
    if (this.checked) { calendar.render(); }
    toggleMonth.blur();
  };
  document.addEventListener('keydown', function(e) {
    if (e.key === 'ArrowLeft' && !e.metaKey) {
      calendar.prev();
    } else if (e.key === 'ArrowRight' && !e.metaKey) {
      calendar.next();
    }
  });
});
</script>
